<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>map test</title>
</head>
<link rel="stylesheet" href="CesiumUnminified/Widgets/widgets.css">
<link rel="stylesheet" href="style.css">

<body>
    <div class="topnav">
        Header
    </div>

    <div class="sidenav">
        <button type="button" onclick="toggleVisibility()">Data</button>
    </div>

    <div id="navtab" class="tab">
        <button class="tablinks" onclick="openTab(event, 'data')">Data</button>
        <button class="tablinks" onclick="openTab(event, 'blink')">Blink</button>
    </div>

    <div id="data" class="tabcontent">
        <div class="list" id="list"></div>
        <div class="pagenumbers" id="pagination"></div>
    </div>

    <div id="blink" class="tabcontent">
    </div>

    <div id="map"></div>

    <script src="mago3d/mago3d.js"></script>
    <script src="CesiumUnminified/Cesium.js"></script>
    <script>
        // Handle the navigation tabs
        function toggleVisibility() {
            var e = document.getElementById("navtab");
            if (e.style.display == 'block') {
                e.style.display = 'none';
                tablinks = document.getElementsByClassName("tablinks");
                for (i = 0; i < tablinks.length; i++) {
                    tablinks[i].className = tablinks[i].className.replace(" active", "");
                }
                tabcontent = document.getElementsByClassName("tabcontent");
                for (i = 0; i < tabcontent.length; i++) {
                    tabcontent[i].style.display = "none";
                }
            } else {
                e.style.display = 'block';
            }
        }

        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");

            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }

            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }

            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        // Handle navigation buttons
        const list_element = document.getElementById("list");
        const pagination_element = document.getElementById("pagination");

        var current_page = 1;
        var rows = 10;

        function DisplayList(items, wrapper, rows_per_page, page) {
            wrapper.innerHTML = "";
            page--;

            var start = rows_per_page * page;
            var end = start + rows_per_page;
            var paginatedItems = items.slice(start, end);

            for (var i = 0; i < paginatedItems.length; i++) {
                var item = paginatedItems[i];
                var item_element = document.createElement('div');
                item_element.classList.add("item");
                item_element.innerText = items.length - items.indexOf(item) + " " + item;

                wrapper.appendChild(item_element);
            }
        }

        function SetupPagination(items, wrapper, rows_per_page) {
            wrapper.innerHTML = "";
            var page_count = Math.ceil(items.length / rows_per_page); // roundup
            for (var i = 1; i < page_count + 1; i++) {
                var btn = PaginationButton(i, items);
                wrapper.appendChild(btn);
            }
        }

        function PaginationButton(page, items) {
            var button = document.createElement("button");
            button.innerText = page;

            if (current_page == page) {
                button.classList.add("active");
            }

            button.addEventListener('click', function() {
                current_page = page;
                DisplayList(items, list_element, rows, current_page);

                var current_btn = document.querySelector('.pagenumbers button.active');
                current_btn.classList.remove("active");

                button.classList.add("active");
            })

            return button;
        }

        // Add map and json data
        var geopolicy = {};
        geopolicy.basicGlobe = 'cesium';
        geopolicy.terrainType = 'cesium-ion-default';
        geopolicy.initCameraEnable = true;
        geopolicy.initLatitude = 35.139482;
        geopolicy.initLongitude = 128.917656;
        geopolicy.initAltitude = 500;
        geopolicy.initDuration = 0.5;

        var map = new Mago3D.Mago3d('map', geopolicy);

        var f4dController = map.getF4dController();

        var f4dGroup = {
            "metainfo": {
                "isPhysical": false
            },
            "dataGroupId": 1,
            "dataGroupKey": "guide",
            "dataGroupName": "가이드 데이터 그룹",
            "dataGroupPath": "guide",
            "datas": []
        };

        var elementObject = {
            "metainfo": {
                "isPhysical": true,
                "flipYTexCoords": true,
                "heightReference": "clampToGround",
                "isVisible": true
            },
            "dataId": 1,
            "dataGroupId": 1,
            "dataKey": 'default',
            "dataName": 'default',
            "mappingType": "boundingboxcenter",
            "longitude": 128.917656,
            "latitude": 35.139482,
            "height": 14.177629,
            "heading": 0.000000,
            "pitch": 0.000000,
            "roll": 0.000000
        };

        function loadJSON(callback, pathToJson) {
            var xobj = new XMLHttpRequest();
            xobj.overrideMimeType("application/json");
            xobj.open('GET', pathToJson, true);
            xobj.onreadystatechange = function() {
                if (xobj.readyState == 4 && xobj.status == "200") {
                    // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
                    callback(xobj.responseText);
                }
            };
            xobj.send(null);
        }

        var path = 'f4d/guide/mergedLonsLats.json';
        var datalist = [];

        loadJSON(function(response) {
            // Parse JSON string into object
            var actual_JSON = JSON.parse(response);
            for (var i = 0; i < actual_JSON.length; i++) {
                var newElementObject = JSON.parse(JSON.stringify(elementObject));
                newElementObject.dataKey = actual_JSON[i].data_key;
                newElementObject.dataKey = actual_JSON[i].data_key;
                newElementObject.longitude = actual_JSON[i].longitude;
                newElementObject.latitude = actual_JSON[i].latitude;
                newElementObject.dataId += i;
                f4dGroup.datas.push(newElementObject);
                f4dController.addF4dGroup(f4dGroup);
                datalist.push(actual_JSON[i].data_key);
            }
            DisplayList(datalist, list_element, rows, current_page);
            SetupPagination(datalist, pagination_element, rows);
        }, path);
    </script>
</body>

</html>